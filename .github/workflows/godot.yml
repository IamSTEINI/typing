name: "godot-ci export"
on: push

permissions:
  contents: write

env:
  GODOT_VERSION: 4.5
  EXPORT_NAME: index
  PROJECT_PATH: .

jobs:
  export-web:
    name: Web Export
    runs-on: ubuntu-24.04
    container:
      image: barichello/godot-ci:4.5
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: true
      
      - name: Install Git LFS
        run: |
          apt-get update && apt-get install -y git-lfs rsync
          git lfs install
          git lfs version
      
      - name: Setup Godot Templates
        run: |
          mkdir -v -p ~/.local/share/godot/export_templates/
          mv /root/.local/share/godot/export_templates/${GODOT_VERSION}.stable ~/.local/share/godot/export_templates/${GODOT_VERSION}.stable
      
      - name: Web Build
        run: |
          mkdir -v -p build/web
          EXPORT_DIR="$(readlink -f build)"
          cd $PROJECT_PATH
          godot --headless --verbose --import
          godot --headless --verbose --export-release "Web" "$EXPORT_DIR/web/index.html"
      
      - name: Create .gitattributes for LFS in build directory
        run: |
          echo "*.pck filter=lfs diff=lfs merge=lfs -text" > build/web/.gitattributes
          echo "*.wasm filter=lfs diff=lfs merge=lfs -text" >> build/web/.gitattributes
          cat build/web/.gitattributes
      
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: web
          path: build/web
      
      - name: Deploy to GitHub Pages with LFS
        run: |
          set -e
          cd build/web
          git init
          git lfs install
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          # Configure remote with token
          git remote add origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
          git add .
          git commit -m "Deploy to GitHub Pages"
          # Check if gh-pages branch exists and push accordingly
          if git ls-remote --exit-code --heads origin gh-pages; then
            echo "Remote branch exists, using --force-with-lease"
            git fetch origin gh-pages:gh-pages
            git push --force-with-lease=gh-pages origin HEAD:gh-pages
          else
            echo "No remote branch, using initial push"
            git push origin HEAD:gh-pages
          fi
